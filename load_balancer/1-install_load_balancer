#!/usr/bin/env bash
# Script to install and configure HAProxy as a load balancer

set -e

echo "Updating and installing HAProxy..."
sudo apt-get update
sudo apt-get install -y haproxy

echo "Enabling HAProxy via init script..."
sudo sed -i 's/ENABLED=0/ENABLED=1/' /etc/default/haproxy

echo "Configuring HAProxy for web servers..."

# Backup default config
sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak

# Replace with our config
cat <<EOF | sudo tee /etc/haproxy/haproxy.cfg > /dev/null
global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend http_front
    bind *:80
    default_backend http_back

backend http_back
    balance roundrobin
    option http-server-close
    server web1 44.204.185.22:80 check
    server web2 44.201.227.161:80 check
    http-request set-header X-Served-By %[req.hdr(Host)]

EOF

echo "Restarting HAProxy..."
sudo service haproxy restart

echo "HAProxy configured successfully!"

